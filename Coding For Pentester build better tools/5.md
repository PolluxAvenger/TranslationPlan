#5 PHP 脚本之道
##本章梗概
***
+ 网页脚本的有用之处
+ 从 PHP 说起
+ 用 PHP 处理表单
+ 文件处理和命令执行
+ 暂定


很多渗透测试开始转向到基于网页安全的评估，间接地导致了两种类型的渗透方向：即基于网络的和网页的。尽管像 Python 和 Ruby 在前面几章已经深刻作用于网络，甚至二进制底层操作，但是本章依然带你去领略 PHP 在渗透测试中的光芒。 PHP 是很多网页编程人员学习的首选语言其中之一，在谷歌搜索引擎中以"PHP and MySQL"关键字能搜到四百万的结果。虽然这些对对初学的编程人员有益，但是同时方便了渗透测试人员。一个网站的 PHP  语言本身及其安全行交叉部分很小，因此导致了很多 PHP 相关应用易受到攻击。在本章，我们将聚焦于以 PHP 为基本的渗透测试工作者，带领大家发现 PHP 两种不同的用法：远程文件包含和数据收集。

- - -
## 网页脚本在哪里有效
网页脚本提供给我们两种好处。第一种能力是控制网页达到我们目标，另外功能强大的数据收集。当我们对网页脆弱性安全检测时，并发现了一个远程文件包含漏洞，这时我们可以在远程服务器上执行一系列我们的代码，且通过使用一些网页服务器软件来和服务器达到交互。能够执行 shell 命令、操作文件系统与数据库通信,在某些情况下,通过套接字进行通信,可以非常有用地在渗透测试期间利用受损的 Web 服务器。
    在执行测试时,我们可能还需要进行一定程度的凭据盗窃或社会工程。 PHP 和 JavaScript 经常一起工作，在这种情况下我们将 JavaScript 代码注入到一个网页,使网页收集信息并将其发送回我们的接收服务器。在这种情况下,我们的 PHP 将解析出信息和日志,以供将来使用。我们将在第九章看这种类型的例子。


## 开始使用 PHP
PHP 即超文本处理器，是一个主要为 Web 开发设计的 开源脚本语言，PHP 页面通常是 HTML 页面与 PHP 代码混杂在一起，这是为了合并网站的 HTML 代码 。PHP 频繁使用包括两个方面一是数据库应用，二是基于表单处理的应用程序的一部分的页面解析和数据操作。PHP由于其处理数据库很容易且能够响应常见的 Web 2.0 协议如可扩展标记语言(XML)和 JavaScript 对象表示(JSON)。
###PHP 作用领域
PHP功能强大齐全包括数据库,套接字,文件操作等，也可以用于代替 bash 脚本任务或其他基于主机的脚本语言 。我们很少使用PHP来进行渗透测试，这是因为其他基于主机的脚本更易于测试，而 PHP 是基于网页。当然这并不是说我们不去处理文件系统操作及一些有用的命令行操作，对于PHP来说它可以更深层次的、更全面的去对待这些事。

### PHP 基础
为了运行 PHP 脚本，我们需要确保 Web 服务器是在运行状态。因此在这里我们采用了 Apache 和 BT5 的搭配的服务器架设，并启动命令 `/etc/init.d/apache start`。接着我们将需要运行的 PHP 脚本放在根目录 `/var/lib/www/` 下，最后在本地浏览器上输入 `http://localhost ` 即可访问我们的脚本。
现在我们的网站配置完毕，让我们建立一个简单的 PHP 页面。Base64 是一个在网络传输数据中常见的加密编码，当我们遇到 Base64 加密的数据，很容易看到字符串是以一个或多个"＝"作为结尾标志。这样我们很容易使用一个 PHP 脚本达到解码的目的。对于我们第一个网页，我们希望需要接受输入或通过网址链接或通过表单。当我们递交数据，我们有三种递交数据的方式。第一种是通过 `$_GET` 或 `$_POST` 数组。这些数组我们可以简单的猜测主要包括 POST 和 GET 请求；第二种是通过 `＄_REQUEST` 数组，包括 `$_GET`、`$_POST`数组和 `＄_COOKIE` 数组；第三种是在PHP配置文件中设置register_globals允许。在 PHP 版本 5.x 之后考虑到安全默认都是禁止的，这也是本文在这里说明的原因。   register_globals 通过 GET 或者 POST 方式递交数据从而被设置为一个变量。如果我们递交一个含有 "a＝b" 的字符串，那`＄a`变量会被自动设置为 b 。当我们开始写自己的脚本的时候，我们就喜欢这种特性，让他更好地在服务器上运行，我们要考虑只是代码的兼容性而不是易用性。
```
<?php


   if($_REQUEST['b64'])
   {

    print "Base64 value for " . htmlspecialchars($_REQUEST['b64']) . " is <BR>\n<PRE>";
    print htmlspecialchars(base64_decode($_REQUEST['b64']));
    print "\n</PRE>\n<BR>";
   }
    ?> </BR>
    
<FORM METHOD=POST>
   <TEXTAREA NAME='b64' COLS=80 ROWS=5>
   </TEXTAREA>
   <BR>
   <INPUT TYPE=SUBMIT VALUE="Submit!">
</FORM>


```
当我们打开 PHP 代码块，有两种方式：<?php 开头或者 <? 标签开头。 <?标签开头的我们称呼为 short_open_tag （在 php.ini 设置），正是这种速记的标签出现在以前的版本中存在，我们看到很多快捷方式和一些简短的代码。如果这被禁止了，那在 Web 服务器没办法完成解析 PHP代码，会直接输出源代码。显然，这不是理想的结果，但是如果开启了短标签，在调用 XML 格式呈现的时候会出现问题，所以在默认的情况下都是禁止的。这里我们采用主流的 <?php 标签。

